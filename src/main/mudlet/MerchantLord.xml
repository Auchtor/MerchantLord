<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE MudletPackage>
<MudletPackage version="1.001">
	<TriggerPackage>
		<TriggerGroup isActive="yes" isFolder="yes" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>MerchantLord</name>
			<script></script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList />
			<regexCodePropertyList />
			<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
				<name>MerchantLordShopItem</name>
				<script>MerchantLord.parseItemFromShop(matches)</script>
				<triggerType>0</triggerType>
				<conditonLineDelta>0</conditonLineDelta>
				<mStayOpen>0</mStayOpen>
				<mCommand></mCommand>
				<packageName></packageName>
				<mFgColor>#ff0000</mFgColor>
				<mBgColor>#ffff00</mBgColor>
				<mSoundFile></mSoundFile>
				<colorTriggerFgColor>#000000</colorTriggerFgColor>
				<colorTriggerBgColor>#000000</colorTriggerBgColor>
				<regexCodeList>
					<string>^\s+([^\s\d]+)(\d+):\s(.{40,40})\s+([\-\d]+)\s+(\d+)gp$</string>
				</regexCodeList>
				<regexCodePropertyList>
					<integer>1</integer>
				</regexCodePropertyList>
			</Trigger>
			<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
				<name>MerchantLordShopProprietor</name>
				<script>MerchantLord.parseProprietor(matches[2])</script>
				<triggerType>0</triggerType>
				<conditonLineDelta>0</conditonLineDelta>
				<mStayOpen>0</mStayOpen>
				<mCommand></mCommand>
				<packageName></packageName>
				<mFgColor>#ff0000</mFgColor>
				<mBgColor>#ffff00</mBgColor>
				<mSoundFile></mSoundFile>
				<colorTriggerFgColor>#000000</colorTriggerFgColor>
				<colorTriggerBgColor>#000000</colorTriggerBgColor>
				<regexCodeList>
					<string>^Proprietor: ([^\.]+)\.</string>
				</regexCodeList>
				<regexCodePropertyList>
					<integer>1</integer>
				</regexCodePropertyList>
			</Trigger>
		</TriggerGroup>
	</TriggerPackage>
	<TimerPackage />
	<AliasPackage>
		<AliasGroup isActive="yes" isFolder="yes">
			<name>MerchantLord</name>
			<script></script>
			<command></command>
			<packageName></packageName>
			<regex></regex>
			<Alias isActive="yes" isFolder="no">
				<name>List Items</name>
				<script>MerchantLord.findItemByString(matches[2])</script>
				<command></command>
				<packageName></packageName>
				<regex>^ml list (.+)$</regex>
			</Alias>
			<Alias isActive="yes" isFolder="no">
				<name>Find Item</name>
				<script>MerchantLord.findItemLocationsByString(matches[2])</script>
				<command></command>
				<packageName></packageName>
				<regex>^ml find (.+)$</regex>
			</Alias>
		</AliasGroup>
	</AliasPackage>
	<ActionPackage />
	<ScriptPackage>
		<ScriptGroup isActive="yes" isFolder="yes">
			<name>MerchantLord</name>
			<packageName></packageName>
			<script>--Script initialization
MerchantLord = MerchantLord or {}

---------
--Version
---------
MerchantLord.version = MerchantLord.version or {
	display = "1.0.0",
	major = 1,
	minor = 0,
	bugfix = 0
}

----------
--Database
----------
MerchantLord.database = db:create("merchantlord", {
	items = {
		short_name = "",
		short_description = "",
		description = "",
		designer = "",
		contents = "",
		_index = {"short_description"},
		_unique = {"short_description"},
		_violations = "REPLACE"
	},
	shops = {
		room_num = 0,
		name = "",
		area = "",
		proprietor = "",
		_index = {"room_num"},
		_unique = {"room_num"},
		_violations = "REPLACE"
	},
	item_locations = {
		item_name = "",
		short_description = "",
		shop = 0,
		quantity = 0,
		price = 0,
		last_seen = db:Timestamp("CURRENT_TIMESTAMP"),
		_index = { {"short_description", "shop"} }
	}
})

-----------
--Utilities
-----------

--Trims a string of prepending and appending whitespace
--as from http://lua-users.org/wiki/StringTrim trim6
function MerchantLord.trimString(s)
	 return s:match'^()%s*$' and '' or s:match'^%s*(.*%S)'
end

--pads s to the right with spaces until it has a length of s
function MerchantLord.padRight(s, length)
	return s .. string.rep(" ", length - string.len(s))
end

--pads s to the left with spaces until it has a length of s
function MerchantLord.padLeft(s, length)
	return string.rep(" ", length - string.len(s)) .. s
end

-----------------
--Database Access
-----------------

--Retrieves the shops table
function MerchantLord.queryAllShops()
	local shopsResult = db:fetch(MerchantLord.database.shops)

	return shopsResult
end

--Retrieves item locations with a short description equal to searchString
function MerchantLord.queryItemLocationsByString(searchString)
	local itemLocationsResult = db:fetch(MerchantLord.database.item_locations,
		db:eq(
			MerchantLord.database.item_locations.short_description,
			searchString
		)
	)

	return itemLocationsResult
end

--Retrieves item data with a short description like searchString or a short name equal to searchString
function MerchantLord.queryItemsByString(searchString)
	local itemResult = db:fetch(MerchantLord.database.items,
		db:OR(
			db:like(
				MerchantLord.database.items.short_description,
				"% " .. searchString .. " %"
			),
			db:like(
				MerchantLord.database.items.short_description,
				"% " .. searchString
			),
			db:like(
				MerchantLord.database.items.short_description,
				searchString .. " %"
			),
			db:eq(
				MerchantLord.database.items.short_name,
				searchString
			)
		)
	)

	return itemResult
end

--Updates or inserts item data
function MerchantLord.upsertItemDataFromShop(itemData)
	local itemRow = db:fetch(
		MerchantLord.database.items,
		db:eq(
			MerchantLord.dataabase.items.short_description,
			itemData.short_description
		)
	)[1]
	
	if itemRow == nil then
		db:add(MerchantLord.database.items,itemData)
	end
end

--Updates or inserts item location data
function MerchantLord.upsertItemLocationData(itemLocationData)
	local itemLocationRow = db:fetch(
		MerchantLord.database.item_locations,
		db:AND(
			db:eq(
				MerchantLord.database.item_locations.item_name,
				itemLocationData.item_name
			),
			db:eq(
				MerchantLord.database.item_locations.shop,
				itemLocationData.shop
			)
		)
	)[1]


	if itemLocationRow == nil then
		db:add(MerchantLord.database.item_locations,itemLocationData)
	else
		itemLocationRow.item_name = itemLocationData.item_name
		itemLocationRow.shop = itemLocationData.shop
		itemLocationRow.quantity = itemLocationData.quantity
		itemLocationRow.price = itemLocationData.price
		itemLocationRow.last_seen = db:Timestamp("CURRENT_TIMESTAMP")
		db:update(MerchantLord.database.item_locations,itemLocationRow)
	end
end

--Updates or inserts shop information from GMCP
function MerchantLord.upsertShop(shop)
	local shopRow = db:fetch(
		MerchantLord.database.shops,
		db:eq(MerchantLord.database.shops.room_num,shop.room_num)
	)[1]
	
	if shopRow == nil then
		db:add(MerchantLord.database.shops,shop)
	else
		shopRow.room_num = shop.room_num
		shopRow.area = shop.area
		shopRow.name = shop.name
		db:update(MerchantLord.database.shops,shopRow)
	end
end

--Updates store proprietor information
function MerchantLord.updateProprietor(proprietor)
	local shopRow = db:fetch(
		MerchantLord.database.shops,
		db:eq(MerchantLord.database.shops.room_num,gmcp.Room.Info.num)
	)[1]

	
	if shopRow ~= nil then
		shopRow.proprietor = proprietor
		db:update(MerchantLord.database.shops,shopRow)
	end
end

-----------------------
--Exposed Methods
-----------------------

--Formats shop information from GMCP and calls database storage
function MerchantLord.parseShopInformationFromGMCP()
	local shop = {
		room_num = gmcp.Room.Info.num,
		area = gmcp.Room.Info.area,
		name = gmcp.Room.Info.name
	}
		MerchantLord.upsertShop(shop)
end

--Formats proprietor information from Wares Trigger
function MerchantLord.parseProprietor(proprietor)
		MerchantLord.updateProprietor(proprietor)
end

--Formats shop item information from trigger and calls database storage
function MerchantLord.parseItemFromShop(matchedValues)
	local itemData = {
		item = {
			short_name = matchedValues[2],
			short_description = MerchantLord.trimString(matchedValues[4])
		},
		locationData = {
			item_name = matchedValues[2] .. matchedValues[3],
			short_description = MerchantLord.trimString(matchedValues[4]),
			shop = gmcp.Room.Info.num,
			quantity = matches[5],
			price = matches[6]
		}
	}
	
	MerchantLord.upsertItemDataFromShop(itemData.item)
	MerchantLord.upsertItemLocationData(itemData.locationData)
end

--Displays a list of items like searchString
function MerchantLord.findItemByString(searchString)
	echo("\nSearching database for: " .. searchString .. "\n")
	local items = MerchantLord.queryItemsByString(searchString)

	echo("\n" .. MerchantLord.padLeft("name",14) .. MerchantLord.padRight(":",7) .. MerchantLord.padRight("description",41))

	for key,itemData in pairs(items) do
		echo("\n" .. MerchantLord.padLeft(itemData.short_name,14)	.. MerchantLord.padRight(":",7) .. MerchantLord.padRight(itemData.short_description,41))
	end
end

--Displays item location and price information for a short description equal to searchString
function MerchantLord.findItemLocationsByString(searchString)
	echo("\nSearching database for locations of: " .. searchString .. "\n")
	local itemLocations = MerchantLord.searchItemLocationsByString(searchString)

	echo("\n" .. MerchantLord.padLeft("Price",8) .. MerchantLord.padRight(":",3) .. MerchantLord.padRight("Room Number",8))

	for key,itemLocation in pairs(itemLocations) do
		echo("\n" .. MerchantLord.padLeft(itemLocation.price,8) .. MerchantLord.padRight(":",3) .. MerchantLord.padRight(itemLocation.shop,8))
	end
end</script>
			<eventHandlerList />
			<Script isActive="yes" isFolder="no">
				<name>MLGMCPRoomInfo</name>
				<packageName></packageName>
				<script>function MLGMCPRoomInfo(event)
	if gmcp.Room.Info == nil then
		return
	end
	for index,detail in pairs(gmcp.Room.Info.details) do
		if detail == "shop" then
			MerchantLord.parseShopInformationFromGMCP()
		end
	end
end</script>
				<eventHandlerList>
					<string>gmcp.Room.Info</string>
				</eventHandlerList>
			</Script>
		</ScriptGroup>
	</ScriptPackage>
	<KeyPackage />
	<HelpPackage>
		<helpURL>https://github.com/Auchtor/MerchantLord/</helpURL>
	</HelpPackage>
</MudletPackage>
